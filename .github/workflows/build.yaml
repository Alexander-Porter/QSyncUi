name: Build

on:
  #每天早上，中午，下午触发
  schedule:
    - cron: '0 0,12,18 * * *'
  #每次push到master分支触发
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        build-type: [Debug, Release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ilammy/msvc-dev-cmd@v1

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw'
          tools: 'tools_mingw,qt.tools.win64_mingw810 tools_ninja tools_opensslv3_x64 tools_vcredist,qt.tools.vcredist_msvc2022_x64'
          cache: true

      - uses: lukka/get-cmake@latest



      - name: Run CMake
        run: |
          #set DCMAKE_PREFIX_PATH to environment variable %QTDIR%
          cmake -B build -S . -G "MinGW Makefiles" -DCMAKE_PREFIX_PATH=$env:QTDIR  -DCMAKE_BUILD_TYPE=${{ matrix.build-type }}
          cmake --build build --config ${{ matrix.build-type }} --parallel 32

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          path: build/${{ matrix.build-type }}
          name: ${{ matrix.build-type }}

      - name: Use windeployqt
        run: |
          windeployqt.exe build/${{ matrix.build-type }}/QSyncUi.exe

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          path: build/${{ matrix.build-type }}
          name: ${{ matrix.build-type }}-deployed


      - name: Compress artifacts
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          7z a build/${{ matrix.build-type }}.7z build/${{ matrix.build-type }}

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          body_path: ext/${{github.ref_name}}-CHANGELOG

      - name: Upload Release Asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/${{ matrix.build-type }}.7z
      
